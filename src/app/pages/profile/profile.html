<section class="container stack">
  <header class="topbar">
    <div>
      <h1>Meu perfil</h1>
      <p class="muted">Gerencie as informações da sua conta.</p>
    </div>
    <div class="actions">
      <button class="btn btn--ghost" [disabled]="loading()" (click)="refresh()">
        @if (loading()) { Atualizando… } @else { Atualizar }
      </button>
      <a class="btn" routerLink="/user">← Voltar</a>
      <button class="btn btn--danger" (click)="logout()">Sair</button>
    </div>
  </header>

  @if (store.user()) {
    <section class="card">
      <form [formGroup]="form" class="form">
        <div class="grid-2">
          <label>
            <span>Nome</span>
            @if (!editing()) { <div>{{ form.get('name')?.value }}</div> }
            @else {
              <input class="input" formControlName="name" />
              @if (form.get('name')?.invalid && form.get('name')?.touched) {
                <div class="state error">Informe ao menos 2 caracteres.</div>
              }
            }
          </label>

          <label>
            <span>E-mail</span>
            <input class="input" formControlName="email" />
          </label>
        </div>

        <div>
          <span class="muted">Roles</span><br />
          @if ($any(store.user()?.roles)?.length) {
            @for (r of $any(store.user()?.roles); track r) { <span class="badge">{{ r }}</span> }
          } @else { <span class="muted">—</span> }
        </div>

        <div class="actions">
          @if (!editing()) {
            <button type="button" class="btn btn--primary" (click)="enableEdit()">Editar</button>
          } @else {
            <button type="button" class="btn" (click)="cancelEdit()">Cancelar</button>
            <button type="button" class="btn btn--primary" [disabled]="saving() || form.invalid" (click)="save()">
              @if (saving()) { Salvando… } @else { Salvar }
            </button>
          }
        </div>
      </form>
    </section>
  } @else {
    <div class="state muted">Nenhum usuário em cache. Faça login novamente.</div>
  }

  @if (error()) { <div class="state error">{{ error() }}</div> }
  @if (success()) { <div class="state" style="background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46">
    {{ success() }}
  </div> }
</section>
